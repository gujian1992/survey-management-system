<template>
  <PageContainer>
    <PageHeader 
      title="ÊàëÁöÑÁ≠îÈ¢òËÆ∞ÂΩï"
      subtitle="Êü•ÁúãÊÇ®ÁöÑÁ≠îÈ¢òÂéÜÂè≤ÂíåÊàêÁª©ÁªüËÆ°"
    >
      <template #extra>
        <div class="header-actions">
          <SafeRouterLink to="/start-answer" tag="el-button" class="el-button el-button--primary">
            <el-icon><Edit /></el-icon>
            ÂºÄÂßãÊñ∞ÁöÑÁ≠îÈ¢ò
          </SafeRouterLink>
        </div>
      </template>
    </PageHeader>

    <!-- üéØ ÁªüËÆ°Èù¢Êùø -->
    <div class="stats-section">
      <div class="stats-grid">
        <MetricCard
          :metric="{
            type: 'primary',
            value: userStats.totalSessions,
            label: 'ÊÄªÁ≠îÈ¢òÊ¨°Êï∞',
            icon: 'Document',
            iconColor: '#409eff'
          }"
        />
        <MetricCard
          :metric="{
            type: 'success',
            value: userStats.completedSessions,
            label: 'Â∑≤ÂÆåÊàê',
            icon: 'CircleCheck',
            iconColor: '#67c23a',
            progress: userStats.completionRate
          }"
        />
        <MetricCard
          :metric="{
            type: 'warning',
            value: userStats.averageScore,
            label: 'Âπ≥ÂùáÂæóÂàÜ',
            icon: 'Star',
            iconColor: '#e6a23c',
            unit: 'ÂàÜ',
            change: userStats.scoreImprovement
          }"
        />
        <MetricCard
          :metric="{
            type: 'info',
            value: userStats.totalTimeSpent,
            label: 'ÊÄªÁî®Êó∂',
            icon: 'Clock',
            iconColor: '#909399'
          }"
        />
      </div>
    </div>

    <!-- üéØ Á≠õÈÄâÈù¢Êùø -->
    <SearchPanel
      :search-model="searchForm"
      @search="loadSessions"
      @reset="resetSearch"
    >
      <template #search-fields>
        <el-form-item label="Áä∂ÊÄÅ">
          <el-select v-model="searchForm.status" placeholder="ÂÖ®ÈÉ®Áä∂ÊÄÅ" clearable style="width: 150px">
            <el-option label="ÂÖ®ÈÉ®Áä∂ÊÄÅ" :value="0" />
            <el-option label="ËøõË°å‰∏≠" :value="1" />
            <el-option label="Â∑≤ÂÆåÊàê" :value="2" />
            <el-option label="Â∑≤Ë∂ÖÊó∂" :value="3" />
            <el-option label="Â∑≤ÊîæÂºÉ" :value="4" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="È¢òÂûã">
          <el-select v-model="searchForm.questionType" placeholder="ÂÖ®ÈÉ®È¢òÂûã" clearable style="width: 150px">
            <el-option label="ÂÖ®ÈÉ®È¢òÂûã" :value="0" />
            <el-option label="ÂçïÈÄâÈ¢ò" :value="1" />
            <el-option label="Â§öÈÄâÈ¢ò" :value="2" />
            <el-option label="Â°´Á©∫È¢ò" :value="3" />
            <el-option label="ÁÆÄÁ≠îÈ¢ò" :value="4" />
            <el-option label="ËØÑÂàÜÈ¢ò" :value="5" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="Êó∂Èó¥ËåÉÂõ¥">
          <el-date-picker
            v-model="searchForm.dateRange"
            type="daterange"
            range-separator="Ëá≥"
            start-placeholder="ÂºÄÂßãÊó•Êúü"
            end-placeholder="ÁªìÊùüÊó•Êúü"
            style="width: 240px"
            :shortcuts="timeShortcuts"
          />
        </el-form-item>
      </template>
    </SearchPanel>

    <!-- üéØ Êï∞ÊçÆË°®Ê†º -->
    <DataTable
      :loading="loading"
      :data="sessionsList"
      :pagination="{
        current: pagination.current,
        size: pagination.size,
        total: pagination.total,
        showSizeChanger: true,
        showQuickJumper: true
      }"
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
    >
      <!-- ‰ºöËØùÁºñÁ†Å -->
      <el-table-column prop="sessionCode" label="‰ºöËØùÁºñÁ†Å" min-width="180" align="center">
        <template #default="{ row }">
          <el-link 
            type="primary" 
            @click="viewDetail(row)"
            class="session-link"
          >
            {{ row.sessionCode }}
          </el-link>
        </template>
      </el-table-column>
      
      <!-- È¢òÂûã -->
      <el-table-column prop="questionType" label="È¢òÂûã" min-width="100" align="center">
        <template #default="{ row }">
          <el-tag :type="getQuestionTypeTag(row.questionType)" size="small">
            {{ getQuestionTypeName(row.questionType) }}
          </el-tag>
        </template>
      </el-table-column>
      
      <!-- Á≠îÈ¢òÁî®Êó∂ -->
      <el-table-column label="Á≠îÈ¢òÁî®Êó∂" min-width="120" align="center">
        <template #default="{ row }">
          <div class="time-cell">
            {{ formatTimeSpent(calculateTimeSpent(row)) }}
          </div>
        </template>
      </el-table-column>
      
      <!-- ÂæóÂàÜ -->
      <el-table-column prop="finalScore" label="ÂæóÂàÜ" min-width="80" align="center">
        <template #default="{ row }">
          <div class="score-cell">
            {{ row.finalScore || 0 }}ÂàÜ
          </div>
        </template>
      </el-table-column>
      
      <!-- Áä∂ÊÄÅ -->
      <el-table-column prop="status" label="Áä∂ÊÄÅ" min-width="90" align="center">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)" size="small">
            {{ getStatusText(row.status) }}
          </el-tag>
        </template>
      </el-table-column>
      
      <!-- ÂºÄÂßãÊó∂Èó¥ -->
      <el-table-column prop="startTime" label="ÂºÄÂßãÊó∂Èó¥" min-width="160" align="center">
        <template #default="{ row }">
          <div class="time-cell">
            <el-icon><Clock /></el-icon>
            <span>{{ formatDateTime(row.startTime) }}</span>
          </div>
        </template>
      </el-table-column>
      
      <!-- Êìç‰Ωú -->
      <el-table-column label="Êìç‰Ωú" width="200" fixed="right" align="center">
        <template #default="{ row }">
          <div class="action-buttons-group">
            <el-button 
              type="primary" 
              size="small" 
              @click="viewDetail(row)"
              plain
              class="action-button"
            >
              <el-icon><View /></el-icon>
              ËØ¶ÊÉÖ
            </el-button>
            
            <el-button 
              v-if="row.status === 1" 
              type="success"
              size="small" 
              @click="continueAnswer(row)"
              plain
              class="action-button"
            >
              <el-icon><CaretRight /></el-icon>
              ÁªßÁª≠
            </el-button>
            
            <el-button 
              v-if="row.status === 1" 
              type="danger"
              size="small" 
              @click="abandonAnswer(row)"
              plain
              class="action-button"
            >
              <el-icon><Close /></el-icon>
              ÊîæÂºÉ
            </el-button>
            
            <el-button 
              v-if="row.status === 2 && row.finalScore > 0" 
              type="warning"
              size="small" 
              @click="viewReport(row)"
              plain
              class="action-button"
            >
              <el-icon><DataBoard /></el-icon>
              Êä•Âëä
            </el-button>
          </div>
        </template>
      </el-table-column>
    </DataTable>

    <!-- ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog v-model="detailVisible" title="Á≠îÈ¢òËØ¶ÊÉÖ" width="800px">
      <div v-if="selectedSession" class="detail-content">
        <el-descriptions :column="2" border>
          <el-descriptions-item label="‰ºöËØùÁºñÁ†Å">{{ selectedSession.sessionCode }}</el-descriptions-item>
          <el-descriptions-item label="È¢òÂûã">{{ getQuestionTypeName(selectedSession.questionType) }}</el-descriptions-item>
          <el-descriptions-item label="Áä∂ÊÄÅ">
            <el-tag :type="getStatusType(selectedSession.status)">
              {{ getStatusText(selectedSession.status) }}
            </el-tag>
          </el-descriptions-item>
          <el-descriptions-item label="Á≠îÈ¢òÁî®Êó∂">{{ formatTimeSpent(calculateTimeSpent(selectedSession)) }}</el-descriptions-item>
          <el-descriptions-item label="ÂæóÂàÜ">{{ selectedSession.finalScore || 0 }}ÂàÜ</el-descriptions-item>
          <el-descriptions-item label="ÊÄªÂàÜ">{{ selectedSession.totalScore || 0 }}ÂàÜ</el-descriptions-item>
          <el-descriptions-item label="ÂºÄÂßãÊó∂Èó¥">{{ formatDateTime(selectedSession.startTime) }}</el-descriptions-item>
          <el-descriptions-item label="ÁªìÊùüÊó∂Èó¥">{{ formatDateTime(selectedSession.endTime) }}</el-descriptions-item>
        </el-descriptions>
      </div>
      
      <template #footer>
        <el-button @click="detailVisible = false">ÂÖ≥Èó≠</el-button>
        <el-button 
          v-if="selectedSession && selectedSession.status === 1"
          type="primary" 
          @click="continueAnswer(selectedSession)"
        >
          ÁªßÁª≠Á≠îÈ¢ò
        </el-button>
      </template>
    </el-dialog>
  </PageContainer>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Edit, Search, Refresh, View, CaretRight, DataBoard, Clock,
  Document, CircleCheck, Star, Close
} from '@element-plus/icons-vue'
import { answerSessionApi } from '@/api/answerSession'
import PageContainer from '@/components/layout/PageContainer.vue'
import PageHeader from '@/components/base/PageHeader.vue'
import SearchPanel from '@/components/base/SearchPanel.vue'
import DataTable from '@/components/base/DataTable.vue'
import MetricCard from '@/components/statistics/MetricCard.vue'
import SafeRouterLink from '@/components/SafeRouterLink.vue'
import { scrollbarDebugger } from '@/utils/scrollbarDebugger.js'

// ÁªÑ‰ª∂ÂêçÁß∞
defineOptions({
  name: 'MyAnswerRecords'
})

const router = useRouter()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const loading = ref(false)
const sessionsList = ref([])
const detailVisible = ref(false)
const selectedSession = ref(null)

// Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ
const userStats = ref({
  totalSessions: 0,
  completedSessions: 0,
  averageScore: 0,
  completionRate: 0,
  scoreImprovement: 0,
  totalTimeSpent: '0Â∞èÊó∂'
})

// ÊêúÁ¥¢Ë°®Âçï
const searchForm = reactive({
  status: 0,
  questionType: 0,
  dateRange: []
})

// ÂàÜÈ°µ
const pagination = reactive({
  current: 1,
  size: 10,
  total: 0,
  pages: 1
})

// Êó∂Èó¥Âø´Êç∑ÈÄâÈ°π
const timeShortcuts = [
  {
    text: 'ÊúÄËøë‰∏ÄÂë®',
    value: () => {
      const end = new Date()
      const start = new Date()
      start.setDate(start.getDate() - 7)
      return [start, end]
    }
  },
  {
    text: 'ÊúÄËøë‰∏Ä‰∏™Êúà',
    value: () => {
      const end = new Date()
      const start = new Date()
      start.setDate(start.getDate() - 30)
      return [start, end]
    }
  },
  {
    text: 'ÊúÄËøë‰∏â‰∏™Êúà',
    value: () => {
      const end = new Date()
      const start = new Date()
      start.setDate(start.getDate() - 90)
      return [start, end]
    }
  }
]

// Â∑•ÂÖ∑ÊñπÊ≥ï
const getQuestionTypeName = (type) => {
  const names = {
    0: 'Ê∑∑ÂêàÈ¢òÂûã',
    1: 'ÂçïÈÄâÈ¢ò',
    2: 'Â§öÈÄâÈ¢ò', 
    3: 'Â°´Á©∫È¢ò',
    4: 'ÁÆÄÁ≠îÈ¢ò',
    5: 'ËØÑÂàÜÈ¢ò'
  }
  return names[type] || 'Êú™Áü•'
}

const getQuestionTypeTag = (type) => {
  const tags = {
    0: 'info',
    1: 'primary',
    2: 'success',
    3: 'warning',
    4: 'danger',
    5: 'info'
  }
  return tags[type] || 'info'
}

const getStatusText = (status) => {
  const texts = {
    1: 'ËøõË°å‰∏≠',
    2: 'Â∑≤ÂÆåÊàê',
    3: 'Â∑≤Ë∂ÖÊó∂',
    4: 'Â∑≤ÊîæÂºÉ'
  }
  return texts[status] || 'Êú™Áü•'
}

const getStatusType = (status) => {
  const types = {
    1: 'warning',
    2: 'success',
    3: 'danger',
    4: 'info'
  }
  return types[status] || 'info'
}

const calculateTimeSpent = (session) => {
  if (!session.startTime || !session.endTime) return 0
  const start = new Date(session.startTime)
  const end = new Date(session.endTime)
  return Math.floor((end - start) / 1000) // ËΩ¨Êç¢‰∏∫Áßí
}

const formatTimeSpent = (seconds) => {
  if (seconds < 60) {
    return `${seconds}Áßí`
  }
  const minutes = Math.floor(seconds / 60)
  if (minutes < 60) {
    const remainingSeconds = seconds % 60
    return remainingSeconds > 0 ? `${minutes}ÂàÜ${remainingSeconds}Áßí` : `${minutes}ÂàÜÈíü`
  }
  const hours = Math.floor(minutes / 60)
  const remainingMinutes = minutes % 60
  return remainingMinutes > 0 ? `${hours}Â∞èÊó∂${remainingMinutes}ÂàÜ` : `${hours}Â∞èÊó∂`
}

const formatDateTime = (dateStr) => {
  if (!dateStr) return '-'
  return new Date(dateStr).toLocaleString('zh-CN')
}

// ‰∏ªË¶ÅÊñπÊ≥ï
const loadSessions = async () => {
  try {
    loading.value = true
    const params = {
      current: pagination.current,
      size: pagination.size,
      status: searchForm.status === 0 ? null : searchForm.status,
      questionType: searchForm.questionType === 0 ? null : searchForm.questionType,
      startTime: searchForm.dateRange?.[0],
      endTime: searchForm.dateRange?.[1]
    }
    
    const response = await answerSessionApi.getMySessionList(params)
    if (response.data) {
      // Á°Æ‰øù records ÊòØÊï∞ÁªÑ
      const records = Array.isArray(response.data.records) ? response.data.records : []
      console.log('Âä†ËΩΩÁöÑÁ≠îÈ¢òËÆ∞ÂΩï:', records) // Ê∑ªÂä†Êó•Âøó
      sessionsList.value = records
      pagination.total = response.data.total || 0
      console.log('ÂàÜÈ°µ‰ø°ÊÅØ:', pagination) // Ê∑ªÂä†Êó•Âøó
    }
  } catch (error) {
    console.error('Âä†ËΩΩÁ≠îÈ¢òËÆ∞ÂΩïÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÁ≠îÈ¢òËÆ∞ÂΩïÂ§±Ë¥•')
  } finally {
    loading.value = false
  }
}

const loadUserStats = async () => {
  try {
    const response = await answerSessionApi.getMyStats()
    if (response && response.data) {
      userStats.value = {
        totalSessions: response.data.totalSessions || 0,
        completedSessions: response.data.completedSessions || 0,
        averageScore: response.data.averageScore || 0,
        completionRate: response.data.completionRate || 0,
        scoreImprovement: response.data.scoreImprovement || 0,
        totalTimeSpent: formatMinutes(response.data.totalTimeSpent || 0)
      }
    }
  } catch (error) {
    console.error('Âä†ËΩΩÁî®Êà∑ÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•')
  }
}

// Â∞ÜÂàÜÈíüËΩ¨Êç¢‰∏∫Êõ¥ÂèãÂ•ΩÁöÑÊó∂Èó¥Ê†ºÂºè
const formatMinutes = (minutes) => {
  if (minutes < 60) {
    return `${minutes}ÂàÜÈíü`
  }
  const hours = Math.floor(minutes / 60)
  const remainingMinutes = minutes % 60
  return remainingMinutes > 0 ? `${hours}Â∞èÊó∂${remainingMinutes}ÂàÜÈíü` : `${hours}Â∞èÊó∂`
}

const resetSearch = () => {
  searchForm.status = 0
  searchForm.questionType = 0
  searchForm.dateRange = []
  loadSessions()
}

const viewDetail = (row) => {
  selectedSession.value = row
  detailVisible.value = true
}

const continueAnswer = async (session) => {
  try {
    // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞Á≠îÈ¢òÈ°µÈù¢ÁªßÁª≠Á≠îÈ¢ò
    ElMessage.success('ÁªßÁª≠Á≠îÈ¢ò')
    router.push(`/answer-session/${session.sessionCode}`)
  } catch (error) {
    console.error('ÁªßÁª≠Á≠îÈ¢òÂ§±Ë¥•:', error)
    ElMessage.error('ÁªßÁª≠Á≠îÈ¢òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
  }
}

const abandonAnswer = async (session) => {
  try {
    await ElMessageBox.confirm(
      'Á°ÆÂÆöË¶ÅÊîæÂºÉËøôÊ¨°Á≠îÈ¢òÂêóÔºüÊîæÂºÉÂêéÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ',
      'Á°ÆËÆ§ÊîæÂºÉ',
      {
        confirmButtonText: 'Á°ÆÂÆöÊîæÂºÉ',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )
    
    await answerSessionApi.abandonSession(session.sessionCode)
    ElMessage.success('Â∑≤ÊîæÂºÉÁ≠îÈ¢ò')
    loadSessions() // Âà∑Êñ∞ÂàóË°®
  } catch (error) {
    if (error !== 'cancel') {
      console.error('ÊîæÂºÉÁ≠îÈ¢òÂ§±Ë¥•:', error)
      ElMessage.error('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
    }
  }
}

const viewReport = (row) => {
  ElMessage.info('ÊàêÁª©Êä•ÂëäÂäüËÉΩÂºÄÂèë‰∏≠...')
}

const handleSizeChange = (size) => {
  console.log('ÊîπÂèòÊØèÈ°µÊòæÁ§∫Êï∞Èáè:', size)
  pagination.size = size
  pagination.current = 1
  loadSessions()
}

const handleCurrentChange = (page) => {
  console.log('ÊîπÂèòÂΩìÂâçÈ°µÁ†Å:', page)
  pagination.current = page
  loadSessions()
}

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
  await Promise.all([
    loadUserStats(),
    loadSessions()
  ])
  
  // Âª∂ËøüÊ£ÄÊµãË°®Ê†ºÊªöÂä®Êù°
  setTimeout(() => {
    const tableElement = document.querySelector('.data-table-container .el-table')
    if (tableElement) {
      console.log('üîç ÂºÄÂßãÂàÜÊûêË°®Ê†ºÊªöÂä®Êù°...')
      const analysis = scrollbarDebugger.analyzeTable(tableElement)
      
      if (analysis?.recommendations?.length > 0) {
        console.log('‚ö†Ô∏è ÂèëÁé∞ÊªöÂä®Êù°ÈóÆÈ¢òÔºåÂ∞ùËØïÂ∫îÁî®‰øÆÂ§ç...')
        scrollbarDebugger.applyQuickFix(tableElement)
        
        // ÂÜçÊ¨°Ê£ÄÊµã‰øÆÂ§çÊïàÊûú
        setTimeout(() => {
          const fixAnalysis = scrollbarDebugger.analyzeTable(tableElement)
          const summary = scrollbarDebugger.generateSummary()
          console.log('‚úÖ ‰øÆÂ§çÊïàÊûúÂàÜÊûê:', summary)
        }, 500)
      }
    }
  }, 1000)
})
</script>

<style scoped>
/* üéØ ÁªüËÆ°Èù¢ÊùøÊ†∑Âºè */
.stats-section {
  margin-bottom: 24px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
}

/* üéØ Ë°®Ê†ºÊ†∑Âºè */
.session-link {
  font-weight: 500;
  text-decoration: none;
}

.session-link:hover {
  text-decoration: underline;
}

.progress-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.progress-text {
  font-size: 12px;
  color: #718096;
  white-space: nowrap;
  font-weight: 500;
}

.score-cell {
  font-weight: 600;
  color: #38a169;
  font-size: 14px;
}

.time-cell {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: #4a5568;
}

.time-cell .el-icon {
  color: #718096;
}

/* Ë°®Ê†ºÂÆπÂô®Ê†∑Âºè */
:deep(.el-table) {
  width: 100% !important;
  border-radius: 8px;
  overflow: hidden;
}

:deep(.el-table__body-wrapper) {
  overflow-y: auto;
  min-height: 200px;
  max-height: calc(100vh - 400px);
}

/* üéØ Êìç‰ΩúÊåâÈíÆÁªÑÊ†∑Âºè */
.action-buttons-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
}

.action-button {
  min-width: 64px;
  height: 32px;
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

.action-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.action-button .el-icon {
  font-size: 14px;
}

/* üéØ ËØ¶ÊÉÖÂÜÖÂÆπÊ†∑Âºè */
.detail-content {
  padding: 16px 0;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}
</style> 